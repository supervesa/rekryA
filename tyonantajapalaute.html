<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palaute työhakemuksestani</title>
    <link rel="stylesheet" href="tyylit.css"> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
</head>
<body>
    <div class="container">
        <div class="applicant-name-header">Vesa Nessling</div>
        <div id="employer-job-info"></div> <div id="application-info"></div>

        <h1>Palaute työhakemuksestani</h1>

        <p id="intro-paragraph">Kiitos, että annoitte aikaanne hakemukseni käsittelyyn hakemaani [työnimike] -tehtävään. Vaikka tällä kertaa en tullut valituksi, hakemukseen liittyvä palautteenne olisi minulle erittäin arvokasta. Se auttaisi minua ymmärtämään, miten voisin kehittää hakemuksiani tulevaisuudessa. Kiitos paljon avustanne!</p>

        <form id="applicationFeedbackForm">
            <input type="hidden" id="application_id_fk" name="application_id_fk">
            <input type="hidden" id="job_id_fk" name="job_id_fk">

            <h2>1. Yleisarvio hakemuksesta</h2>
            <div class="slider-container">
                <label for="yleisarvosana_arvio">Antaisitteko yleisarvosanan hakemukselleni kokonaisuutena? (1 = kaipaa paljon kehitystä, 5 = erinomainen)</label>
                <input type="range" id="yleisarvosana_arvio" name="yleisarvosana_arvio" min="1" max="5" step="1" value="3" oninput="this.nextElementSibling.value = this.value" required>
                <output class="slider-value">3</output>
            </div>

            <h2>2. Hakemusta kuvaavat määreet</h2>
            <div class="chip-group-container">
                <div class="chip-group-legend">Valitse hakemusta parhaiten kuvaavat määreet (voit valita useita)</div>
                <div class="chip-group">
                    <input type="checkbox" class="chip-checkbox" id="maare_selkea_split" name="maatreet_valitut" value="Selkeä"><label class="chip-label" for="maare_selkea_split">Selkeä</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_hyvin_jasennelty" name="maatreet_valitut" value="Hyvin jäsennelty"><label class="chip-label" for="maare_hyvin_jasennelty">Hyvin jäsennelty</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_kohdennettu" name="maatreet_valitut" value="Kohdennettu"><label class="chip-label" for="maare_kohdennettu">Kohdennettu työtehtävään</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_vaikuttava_split" name="maatreet_valitut" value="Vaikuttava"><label class="chip-label" for="maare_vaikuttava_split">Vaikuttava</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_mielenkiintoinen" name="maatreet_valitut" value="Mielenkiintoinen"><label class="chip-label" for="maare_mielenkiintoinen">Mielenkiintoinen</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_persoonallinen_split" name="maatreet_valitut" value="Persoonallinen"><label class="chip-label" for="maare_persoonallinen_split">Persoonallinen</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_erottuva" name="maatreet_valitut" value="Erottuva"><label class="chip-label" for="maare_erottuva">Erottuva</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_yleisluontoinen" name="maatreet_valitut" value="Yleisluontoinen"><label class="chip-label" for="maare_yleisluontoinen">Yleisluontoinen</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_puutteellinen_split" name="maatreet_valitut" value="Puutteellinen"><label class="chip-label" for="maare_puutteellinen_split">Puutteellinen</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_epaselva" name="maatreet_valitut" value="Epäselvä"><label class="chip-label" for="maare_epaselva">Epäselvä</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_oikeakielinen" name="maatreet_valitut" value="Oikeakielinen"><label class="chip-label" for="maare_oikeakielinen">Oikeakielinen</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_asiantunteva" name="maatreet_valitut" value="Asiantunteva"><label class="chip-label" for="maare_asiantunteva">Asiantunteva vaikutelma</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_huolellinen" name="maatreet_valitut" value="Huolellinen"><label class="chip-label" for="maare_huolellinen">Huolellinen</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_ammattimainen" name="maatreet_valitut" value="Ammattimainen"><label class="chip-label" for="maare_ammattimainen">Ammattimainen</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_vakuuttava" name="maatreet_valitut" value="Vakuuttava"><label class="chip-label" for="maare_vakuuttava">Vakuuttava</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_innovatiivinen" name="maatreet_valitut" value="Innovatiivinen"><label class="chip-label" for="maare_innovatiivinen">Innovatiivinen</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_analyyttinen" name="maatreet_valitut" value="Analyyttinen"><label class="chip-label" for="maare_analyyttinen">Analyyttinen</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_ratkaisukeskeinen" name="maatreet_valitut" value="Ratkaisukeskeinen"><label class="chip-label" for="maare_ratkaisukeskeinen">Ratkaisukeskeinen</label>
                    <input type="checkbox" class="chip-checkbox" id="maare_positiivinen" name="maatreet_valitut" value="Positiivinen"><label class="chip-label" for="maare_positiivinen">Positiivinen yleisvaikutelma</label>
                </div>
            </div>

            <h2>3. Arvio hakemuksen eri osa-alueista</h2>

            <div class="slider-container">
                <label for="motivaatio_arvio">Miten hyvin koitte motivaationi ja kiinnostukseni ilmenevän hakemuksesta?</label>
                <input type="range" id="motivaatio_arvio" name="motivaatio_arvio" min="1" max="5" step="1" value="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>
            <div class="slider-container">
                <label for="koulutus_arvio">Miten arvioitte koulutukseni vastaavan haettuun työtehtävään?</label>
                <input type="range" id="koulutus_arvio" name="koulutus_arvio" min="1" max="5" step="1" value="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>
            <div class="slider-container">
                <label for="kokemus_arvio">Miten arvioitte työkokemukseni soveltuvuutta haettuun työtehtävään?</label>
                <input type="range" id="kokemus_arvio" name="kokemus_arvio" min="1" max="5" step="1" value="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>
            <div class="slider-container">
                <label for="tietotekniset_taidot_arvio">Miten arvioitte tietoteknisiä taitojani hakemuksen perusteella?</label>
                <input type="range" id="tietotekniset_taidot_arvio" name="tietotekniset_taidot_arvio" min="1" max="5" step="1" value="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>
            <div class="slider-container">
                <label for="vastaavuus_kokonaisuus_arvio">Miten hakemukseni kokonaisuutena vastasi mielestänne haettua työtehtävää?</label>
                <input type="range" id="vastaavuus_kokonaisuus_arvio" name="vastaavuus_kokonaisuus_arvio" min="1" max="5" step="1" value="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>
            <div class="slider-container">
                <label for="osaaminen_arvio">Miten ammatillinen osaamiseni tuli esille hakemuksessa?</label>
                <input type="range" id="osaaminen_arvio" name="osaaminen_arvio" min="1" max="5" step="1" value="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>

            <h2>4. Vapaamuotoiset huomiot ja kehitysvinkit hakemukseen liittyen</h2>
             <p class="section-description">Tässä on tilaa kaikille muille vapaamuotoisille huomioille hakemuksestani sekä erityisesti vinkeille, miten voisin kehittää hakemuksiani paremmiksi tulevaisuudessa.</p>
            <div>
                <label for="arviointi_lisatietoa_muuta">Vapaamuotoinen palaute ja vinkit hakemukseeni liittyen</label>
                <textarea id="arviointi_lisatietoa_muuta" name="arviointi_lisatietoa_muuta" rows="5"></textarea>
            </div>

               <button type="submit" id="submitButton">Lähetä palaute</button>
            <div id="form-feedback"></div>
    </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://kistxgsnxvfftgshbpax.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpc3R4Z3NueHZmZnRnc2hicGF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4MjQxOTcsImV4cCI6MjA2MjQwMDE5N30.OGcxcwVAX8R925Eq7Vr5vWbtHLqPl_OQBF39R_6nTqQ';

            if (typeof supabase === 'undefined' || typeof supabase.createClient !== 'function') {
                console.error('Supabase client (supabase.createClient) ei ole ladattu tai se ei ole funktio.');
                const feedbackDiv = document.getElementById('form-feedback');
                if (feedbackDiv) {
                    feedbackDiv.textContent = 'Virhe alustuksessa. Yritä myöhemmin uudelleen.';
                    feedbackDiv.className = 'error';
                }
                return;
            }
            
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const form = document.getElementById('applicationFeedbackForm');
            const feedbackDiv = document.getElementById('form-feedback');
            const submitButton = document.getElementById('submitButton');
            const applicationInfoDiv = document.getElementById('application-info');
            const employerJobInfoDiv = document.getElementById('employer-job-info'); 
            const introParagraph = document.getElementById('intro-paragraph'); 
            const appIdHiddenField = document.getElementById('application_id_fk');
            const jobIdHiddenField = document.getElementById('job_id_fk');


            const urlParams = new URLSearchParams(window.location.search);
            const applicationIdFk = urlParams.get('appId');
            const jobIdFk = urlParams.get('jobId');
            const applicantName = urlParams.get('applicantName');
            const jobTitle = urlParams.get('jobTitle');
            const employerName = urlParams.get('employerName'); 

            if (employerJobInfoDiv) {
                let employerJobText = '';
                if (employerName && jobTitle) {
                    employerJobText = `${decodeURIComponent(employerName)} - ${decodeURIComponent(jobTitle)}`;
                } else if (jobTitle) {
                    employerJobText = decodeURIComponent(jobTitle);
                } else if (employerName) {
                    employerJobText = decodeURIComponent(employerName);
                }
                employerJobInfoDiv.textContent = employerJobText;
            }
            
            if (introParagraph) {
                let currentText = introParagraph.innerHTML;
                if (jobTitle) {
                    currentText = currentText.replace('[työnimike]', `"${decodeURIComponent(jobTitle)}"`);
                } else {
                    // Jos työnimikettä ei ole, poistetaan paikkamerkki ja sitä ympäröivä osa lauseesta siistimmin
                    currentText = currentText.replace('hakemaani [työnimike] -tehtävään', 'hakemaani tehtävään');
                }
                introParagraph.innerHTML = currentText;
            }


            if (applicationIdFk) {
                if (appIdHiddenField) {
                    appIdHiddenField.value = applicationIdFk;
                }
                if (applicationInfoDiv) {
                    let infoText = `Palaute hakemukselle ID: ${applicationIdFk}`;
                    if (applicantName && jobTitle) {
                        infoText = `Palaute hakemukselle: ${decodeURIComponent(applicantName)} - ${decodeURIComponent(jobTitle)} (ID: ${applicationIdFk})`;
                    } else if (jobTitle) {
                        infoText = `Palaute hakemukselle työpaikkaan: ${decodeURIComponent(jobTitle)} (ID: ${applicationIdFk})`;
                    } else if (applicantName && applicantName.toLowerCase() !== applicationIdFk.toLowerCase()) {
                         infoText = `Palaute hakemukselle: ${decodeURIComponent(applicantName)} (ID: ${applicationIdFk})`;
                    }
                    applicationInfoDiv.textContent = infoText;
                }
            } else {
                if (feedbackDiv) {
                    feedbackDiv.textContent = 'Virhe: Hakemuksen ID (appId) puuttuu URL-parametreista.';
                    feedbackDiv.className = 'error';
                }
                if (submitButton) submitButton.disabled = true;
            }

            if (jobIdFk) {
                 if (jobIdHiddenField) {
                    jobIdHiddenField.value = jobIdFk;
                }
            }
            
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                if (slider.nextElementSibling && slider.nextElementSibling.tagName === 'OUTPUT') {
                    slider.nextElementSibling.value = slider.value;
                }
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (submitButton) submitButton.disabled = true;
                if (feedbackDiv) {
                    feedbackDiv.textContent = 'Lähetetään...';
                    feedbackDiv.className = '';
                }

                const formData = new FormData(form);
                const formProps = Object.fromEntries(formData);

                const maatreetValitut = [];
                form.querySelectorAll('input[name="maatreet_valitut"]:checked').forEach((checkbox) => {
                    maatreetValitut.push(checkbox.value);
                });

                const getIntOrNull = (value) => {
                    if (value === null || value === undefined || String(value).trim() === '') {
                        return null;
                    }
                    const parsed = parseInt(String(value).trim(), 10);
                    return isNaN(parsed) ? null : parsed;
                };

                const dataToSubmit = {
                    application_id_fk: formProps.application_id_fk,
                    job_id_fk: formProps.job_id_fk || null,
                    yleisarvosana_arvio: getIntOrNull(formProps.yleisarvosana_arvio),
                    maatreet_valitut: maatreetValitut.length > 0 ? maatreetValitut : null,
                    motivaatio_arvio: getIntOrNull(formProps.motivaatio_arvio),
                    koulutus_arvio: getIntOrNull(formProps.koulutus_arvio),
                    kokemus_arvio: getIntOrNull(formProps.kokemus_arvio),
                    tietotekniset_taidot_arvio: getIntOrNull(formProps.tietotekniset_taidot_arvio),
                    vastaavuus_kokonaisuus_arvio: getIntOrNull(formProps.vastaavuus_kokonaisuus_arvio),
                    osaaminen_arvio: getIntOrNull(formProps.osaaminen_arvio),
                    arviointi_lisatietoa_muuta: formProps.arviointi_lisatietoa_muuta || null
                };
                
                const { data, error } = await supabaseClient
                    .from('tyonantaja_palautteet')
                    .insert([dataToSubmit])
                    .select();

                if (error) {
                    console.error('Virhe tallennettaessa Supabaseen:', error);
                    if (feedbackDiv) {
                        feedbackDiv.textContent = `Virhe: ${error.message}`;
                        feedbackDiv.className = 'error';
                    }
                    if (submitButton) submitButton.disabled = false;
                } else {
                    if (feedbackDiv) {
                        feedbackDiv.textContent = 'Palaute tallennettu onnistuneesti! Kiitos.';
                        feedbackDiv.className = 'success';
                        form.reset();
                         document.querySelectorAll('input[type="range"]').forEach(slider => {
                           if (slider.nextElementSibling && slider.nextElementSibling.tagName === 'OUTPUT') {
                               slider.nextElementSibling.value = slider.defaultValue || '3';
                           }
                        });
                        if (submitButton) submitButton.disabled = true;
                    }
                }
            });
        });
    </script>
</body>
</html>
