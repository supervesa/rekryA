<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Työnantajapalaute</title> <link rel="stylesheet" href="tyylit.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
</head>
<body>
    <div class="container">
        <h1>Palaute työhakemuksestani</h1>

    <p id="application-info" style="text-align:center; margin-bottom: 20px; font-style: italic;"></p>

    <p>Kiitos, että annoitte aikaanne hakemukseni käsittelyyn <span id="job-title-placeholder-hakemus">[Tehtävänimike tähän]</span> -tehtävään. Vaikka tällä kertaa en tullut valituksi, hakemukseen liittyvä palautteenne olisi minulle erittäin arvokasta. Se auttaisi minua ymmärtämään, miten voisin kehittää hakemuksiani tulevaisuudessa. Kiitos paljon avustanne!</p>

    <form id="applicationFeedbackForm">
        <input type="hidden" id="application_id_fk_hakemus" name="application_id_fk">
        <input type="hidden" id="job_id_fk_hakemus" name="job_id_fk">
        <h2>1. Yleisarvio hakemuksesta</h2>
            <div class="slider-container">
                <label for="yleisarvosana_arvio">Antaisitteko yleisarvosanan hakemukselleni kokonaisuutena? (1 = kaipaa paljon kehitystä, 5 = erinomainen):</label>
                <input type="range" id="yleisarvosana_arvio" name="yleisarvosana_arvio" min="1" max="5" step="1" defaultValue="3" oninput="this.nextElementSibling.value = this.value" required>
                <output class="slider-value">3</output>
            </div>

            <h2>2. Hakemusta kuvaavat määreet</h2>
            <div class="chip-group-container">
                <div class="chip-group">
    <input type="checkbox" class="chip-checkbox" id="maare_selkea_split" name="maatreet_valitut" value="Selkeä"><label class="chip-label" for="maare_selkea_split">Selkeä</label>
    <input type="checkbox" class="chip-checkbox" id="maare_hyvin_jasennelty" name="maatreet_valitut" value="Hyvin jäsennelty"><label class="chip-label" for="maare_hyvin_jasennelty">Hyvin jäsennelty</label>

    <input type="checkbox" class="chip-checkbox" id="maare_kohdennettu" name="maatreet_valitut" value="Kohdennettu"><label class="chip-label" for="maare_kohdennettu">Kohdennettu työtehtävään</label> <input type="checkbox" class="chip-checkbox" id="maare_vaikuttava_split" name="maatreet_valitut" value="Vaikuttava"><label class="chip-label" for="maare_vaikuttava_split">Vaikuttava</label>
    <input type="checkbox" class="chip-checkbox" id="maare_mielenkiintoinen" name="maatreet_valitut" value="Mielenkiintoinen"><label class="chip-label" for="maare_mielenkiintoinen">Mielenkiintoinen</label>

    <input type="checkbox" class="chip-checkbox" id="maare_persoonallinen_split" name="maatreet_valitut" value="Persoonallinen"><label class="chip-label" for="maare_persoonallinen_split">Persoonallinen</label>
    <input type="checkbox" class="chip-checkbox" id="maare_erottuva" name="maatreet_valitut" value="Erottuva"><label class="chip-label" for="maare_erottuva">Erottuva</label>

    <input type="checkbox" class="chip-checkbox" id="maare_yleisluontoinen" name="maatreet_valitut" value="Yleisluontoinen"><label class="chip-label" for="maare_yleisluontoinen">Yleisluontoinen</label>

    <input type="checkbox" class="chip-checkbox" id="maare_puutteellinen_split" name="maatreet_valitut" value="Puutteellinen"><label class="chip-label" for="maare_puutteellinen_split">Puutteellinen</label>
    <input type="checkbox" class="chip-checkbox" id="maare_epaselva" name="maatreet_valitut" value="Epäselvä"><label class="chip-label" for="maare_epaselva">Epäselvä</label>

    <input type="checkbox" class="chip-checkbox" id="maare_oikeakielinen" name="maatreet_valitut" value="Oikeakielinen"><label class="chip-label" for="maare_oikeakielinen">Oikeakielinen</label>
    <input type="checkbox" class="chip-checkbox" id="maare_asiantunteva" name="maatreet_valitut" value="Asiantunteva"><label class="chip-label" for="maare_asiantunteva">Asiantunteva vaikutelma</label>
    <input type="checkbox" class="chip-checkbox" id="maare_huolellinen" name="maatreet_valitut" value="Huolellinen"><label class="chip-label" for="maare_huolellinen">Huolellinen</label>
    <input type="checkbox" class="chip-checkbox" id="maare_ammattimainen" name="maatreet_valitut" value="Ammattimainen"><label class="chip-label" for="maare_ammattimainen">Ammattimainen</label>
    <input type="checkbox" class="chip-checkbox" id="maare_vakuuttava" name="maatreet_valitut" value="Vakuuttava"><label class="chip-label" for="maare_vakuuttava">Vakuuttava</label>
    <input type="checkbox" class="chip-checkbox" id="maare_innovatiivinen" name="maatreet_valitut" value="Innovatiivinen"><label class="chip-label" for="maare_innovatiivinen">Innovatiivinen</label>
    <input type="checkbox" class="chip-checkbox" id="maare_analyyttinen" name="maatreet_valitut" value="Analyyttinen"><label class="chip-label" for="maare_analyyttinen">Analyyttinen</label>
    <input type="checkbox" class="chip-checkbox" id="maare_ratkaisukeskeinen" name="maatreet_valitut" value="Ratkaisukeskeinen"><label class="chip-label" for="maare_ratkaisukeskeinen">Ratkaisukeskeinen</label>
    <input type="checkbox" class="chip-checkbox" id="maare_positiivinen" name="maatreet_valitut" value="Positiivinen"><label class="chip-label" for="maare_positiivinen">Positiivinen yleisvaikutelma</label>
</div>
            </div>

            <h2>3. Arvio hakemuksen eri osa-alueista</h2>

            <div class="slider-container">
                <label for="motivaatio_arvio">Miten hyvin koitte motivaationi ja kiinnostukseni ilmenevän hakemuksesta? (Arvio 1–5):</label>
                <input type="range" id="motivaatio_arvio" name="motivaatio_arvio" min="1" max="5" step="1" defaultValue="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>
            <div class="slider-container">
                <label for="koulutus_arvio">Miten arvioitte koulutukseni vastaavan haettuun työtehtävään? (Arvio 1–5):</label>
                <input type="range" id="koulutus_arvio" name="koulutus_arvio" min="1" max="5" step="1" defaultValue="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>
            <div class="slider-container">
                <label for="kokemus_arvio">Miten arvioitte työkokemukseni soveltuvuutta haettuun työtehtävään? (Arvio 1–5):</label>
                <input type="range" id="kokemus_arvio" name="kokemus_arvio" min="1" max="5" step="1" defaultValue="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>
            <div class="slider-container">
                <label for="tietotekniset_taidot_arvio">Miten arvioitte tietoteknisiä taitojani hakemuksen perusteella? (Arvio 1–5):</label>
                <input type="range" id="tietotekniset_taidot_arvio" name="tietotekniset_taidot_arvio" min="1" max="5" step="1" defaultValue="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>
            <div class="slider-container">
                <label for="vastaavuus_kokonaisuus_arvio">Miten hakemukseni kokonaisuutena vastasi mielestänne haettua työtehtävää? (Arvio 1–5):</label>
                <input type="range" id="vastaavuus_kokonaisuus_arvio" name="vastaavuus_kokonaisuus_arvio" min="1" max="5" step="1" defaultValue="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>
            <div class="slider-container">
                <label for="osaaminen_arvio">Miten ammatillinen osaamiseni tuli esille hakemuksessa? (Arvio 1–5):</label>
                <input type="range" id="osaaminen_arvio" name="osaaminen_arvio" min="1" max="5" step="1" defaultValue="3" oninput="this.nextElementSibling.value = this.value">
                <output class="slider-value">3</output>
            </div>

            <h2>4. Vapaamuotoiset huomiot ja kehitysvinkit hakemukseen liittyen</h2>
             <p class="section-description">Tässä on tilaa kaikille muille vapaamuotoisille huomioille hakemuksestani sekä erityisesti vinkeille, miten voisin kehittää hakemuksiani paremmiksi tulevaisuudessa.</p>
            <div>
                <label for="arviointi_lisatietoa_muuta">Vapaamuotoinen palaute ja vinkit hakemukseeni liittyen:</label>
                <textarea id="arviointi_lisatietoa_muuta" name="arviointi_lisatietoa_muuta" rows="5"></textarea>
            </div>

               <button type="submit" id="submitButton">Lähetä palaute</button>
            <div id="form-feedback"></div>
    </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => { // KÄÄRITTY KOKO SKRIPTI
            const SUPABASE_URL = 'https://kistxgsnxvfftgshbpax.supabase.co'; 
            const SUPABASE_ANON_KEY = '.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtpc3R4Z3NueHZmZnRnc2hicGF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4MjQxOTcsImV4cCI6MjA2MjQwMDE5N30.OGcxcwVAX8R925Eq7Vr5vWbtHLqPl_OQBF39R_6nTqQ'; 

            if (typeof supabase === 'undefined' || typeof supabase.createClient !== 'function') {
                console.error('Supabase client (supabase.createClient) ei ole ladattu tai se ei ole funktio.');
                const feedbackDiv = document.getElementById('form-feedback');
                if (feedbackDiv) {
                    feedbackDiv.textContent = 'Virhe alustuksessa. Yritä myöhemmin uudelleen.';
                    feedbackDiv.className = 'error';
                }
                return; 
            }
            
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // KÄYTETÄÄN OIKEAA ALUSTUSTA
            const form = document.getElementById('employerFeedbackForm');
            const feedbackDiv = document.getElementById('form-feedback');
            const submitButton = document.getElementById('submitButton');
            const applicationInfoDiv = document.getElementById('application-info');

            const urlParams = new URLSearchParams(window.location.search);
            const applicationIdFk = urlParams.get('appId');
            const jobIdFk = urlParams.get('jobId');
            const applicantName = urlParams.get('applicantName'); 
            const jobTitle = urlParams.get('jobTitle'); 

            if (applicationIdFk) {
                document.getElementById('application_id_fk').value = applicationIdFk;
                 if (applicantName && jobTitle) {
                    applicationInfoDiv.textContent = `Palaute hakemukselle: ${decodeURIComponent(applicantName)} - ${decodeURIComponent(jobTitle)}`;
                } else if (jobTitle) {
                    applicationInfoDiv.textContent = `Palaute hakemukselle työpaikkaan: ${decodeURIComponent(jobTitle)}`;
                } else {
                     applicationInfoDiv.textContent = `Palaute hakemukselle ID: ${applicationIdFk}`;
                }
            } else {
                if (feedbackDiv) {
                    feedbackDiv.textContent = 'Virhe: Hakemuksen ID (appId) puuttuu URL-parametreista.';
                    feedbackDiv.className = 'error';
                }
                if (submitButton) submitButton.disabled = true;
            }

            if (jobIdFk) {
                document.getElementById('job_id_fk').value = jobIdFk;
            }
            
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                if (slider.nextElementSibling && slider.nextElementSibling.tagName === 'OUTPUT') {
                    slider.nextElementSibling.value = slider.value;
                }
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (submitButton) submitButton.disabled = true;
                if (feedbackDiv) {
                    feedbackDiv.textContent = 'Lähetetään...';
                    feedbackDiv.className = '';
                }

                const formData = new FormData(form);
                const formProps = Object.fromEntries(formData);

                const maatreet = [];
                form.querySelectorAll('input[name="maatreet_valitut"]:checked').forEach((checkbox) => {
                    maatreet.push(checkbox.value);
                });

                const dataToSubmit = {
                    application_id_fk: formProps.application_id_fk,
                    job_id_fk: formProps.job_id_fk || null,
                    yleisarvosana_arvio: formProps.yleisarvosana_arvio ? parseInt(formProps.yleisarvosana_arvio) : null,
                    maatreet_valitut: maatreet.length > 0 ? maatreet : null, 
                    motivaatio_arvio: formProps.motivaatio_arvio ? parseInt(formProps.motivaatio_arvio) : null,
                    koulutus_arvio: formProps.koulutus_arvio ? parseInt(formProps.koulutus_arvio) : null,
                    kokemus_arvio: formProps.kokemus_arvio ? parseInt(formProps.kokemus_arvio) : null,
                    tietotekniset_taidot_arvio: formProps.tietotekniset_taidot_arvio ? parseInt(formProps.tietotekniset_taidot_arvio) : null,
                    vastaavuus_kokonaisuus_arvio: formProps.vastaavuus_kokonaisuus_arvio ? parseInt(formProps.vastaavuus_kokonaisuus_arvio) : null,
                    osaaminen_arvio: formProps.osaaminen_arvio ? parseInt(formProps.osaaminen_arvio) : null,
                    arviointi_lisatietoa_muuta: formProps.arviointi_lisatietoa_muuta || null
                };
                
                Object.keys(dataToSubmit).forEach(key => {
                    if (key.endsWith('_arvio') && dataToSubmit[key] === '') { 
                        dataToSubmit[key] = null;
                    }
                });

                console.log("Lähetetään Supabaseen (työnantajapalaute):", dataToSubmit);

                const { data, error } = await supabaseClient // KÄYTETÄÄN OIKEAA CLIENT-MUUTTUJAA
                    .from('tyonantaja_palautteet') 
                    .insert([dataToSubmit])
                    .select();

                if (error) {
                    console.error('Virhe tallennettaessa Supabaseen:', error);
                    if (feedbackDiv) {
                        feedbackDiv.textContent = `Virhe: ${error.message}`;
                        feedbackDiv.className = 'error';
                    }
                    if (submitButton) submitButton.disabled = false;
                } else {
                    console.log('Tallennettu data:', data);
                    if (feedbackDiv) {
                        feedbackDiv.textContent = 'Palaute tallennettu onnistuneesti! Kiitos.';
                        feedbackDiv.className = 'success';
                    }
                }
            });
        });
    </script>
</body>
</html>